## 암호화폐란 무엇인가?

암호화폐는 3계층 구조로 이루어져 단순히 '돈'이 아닌, 기술 위에 쌓아 올린 거대한 시스템이다.

1. Layer 1. 블록체인 기술 : 암호화폐의 기반이 되는 인프라 기술이다.

2. Layer 2. 프로토콜 & 코인 (Protocol & Coin) : 블록체인 기술을 활용하여 네트워크 참가자들이 소통하는 규칙(protocol)과 그 안에서 사용되는 화폐(coin)이다.

3. Layer 3. 토큰 (Token) : Layer2 위에서 작동하는 응용 프로그램(dApp)이나 특정 서비스에서 사용되는 화폐(token)이다. 독자적인 블록체인은 없으며 남의 블록체인(주로 이더리움)에 얹혀서
   돌아간다.

비트코인은 은행(중재자) 없이 개인 간(P2P) 신뢰를 가능하게 하는 전자 화폐 시스템이라고 볼 수 있다.

생태계 구성원으로는 **노드**(Nodes, 거래를 전파하고 장부를 검증하는 이란 참여자), **채굴자**(Miners, 전력을 써서 블록을 생성하고 보상을 받는 참여자),
**채굴 풀**(Mining Pools, 채굴자들이 모여서 채굴 확률을 높이는 조직) 등이 있다.

## 비트코인의 통화 정책

비트코인은 Code is Law 라는 철학 아래, 미리 정해진 통화 정책에 따라 발행량과 속도가 엄격히 관리된다.
이 시스템은 반감기(Halving)과 블록 빈도(Block Frequency)라는 두 가지 핵심 메커니즘을 통해 작동한다.

### 반감기 (Halving)

비트코인은 소스 코드에서 21만 블록마다 채굴 보상을 절반으로 줄인다는 규칙이 하드코딩외어 있다. 이를 반감기(Halving)라고 부른다.
예를 들어, 2009년 비트코인이 처음 출시되었을 때 채굴 보상은 50 BTC였다. 이후 2012년 첫 번째 반감기에서 25 BTC로 줄었고, 2016년 두 번째 반감기에서는 12.5 BTC로, 2020년 세 번째
반감기에서는 6.25 BTC로 감소했다. (이 주기는 약 4년마다 발생한다.)
이러한 반감기는 비트코인의 총 발행량을 2100만 개로 제한하는 데 기여하며, 시간이 지남에 따라 채굴 보상이 감소함에 따라 비트코인의 희소성이 증가한다.

일반적인 법정 화폐는 돈을 계속 찍어내기 때문에 가치가 떨어지는 인플레이션(Inflation)이 발생한다. 반면, 비트코인은 시간이 지날수록 발행량이 줄어들어 디플레이션(Deflation) 특성을 가진다.

수학적으로 계산해보면 보상이 0이 되는 시점은 약 2140년경으로 예상된다. 비트코인의 총 발행량은 2100만 개로 제한되어 있기 때문에, 채굴 보상이 점차 줄어들면서 결국에는 새로운 비트코인이 발행되지 않게 된다.
그 이후에는 코인을 보상으로 받는 것이 아니라, 거래 수수료(Transaction Fees)가 채굴자들의 주요 수입원이 될 것으로 예상된다.

### 수수료 시장 (Fee Market)

현재 채굴자의 수익은 두 가지로 구성된다.

- 블록 보상(Block Reward) : 새로 생성된 비트코인
- 거래 수수료(Transaction Fees) : 블록에 포함된 거래들로부터 얻는 수수료

반감기에 의해 시간이 지나 블록 보상이 줄어들면 비트코인 네트워크는 거래 수수료에 더 의존하게 된다. 이는 채굴자들이 거래를 처리하고 블록을 생성하는 동기를 유지하는 데 중요하다.

### 블록 빈도 (Block Frequency)

비트코인은 전 세계 어디서나 평균 10분마다 하나의 블록이 생성되도록 설계되었다. 이는 전 세계에 퍼져 있는 노드들이 최신 블록 정보를 공유하고 검증하는 데 충분한 시간을 주기 위함으로
너무 빠르면 네트워크가 불안정해시고 `고아 블록(Orphan Block)`이 많이 생길 수 있다.
비트코인 시스템은 채굴 속도가 너무 빨라지거나 느려지지 않도록 **채굴 난이도(Difficulty)** 를 조정하며 이 시간을 유지하기 위해 노력한다.

정리하자면 비트코인은 `인간의 개입 없이, 수학적 알고리즘과 자율 제어 시스템을 통해 통화량과 발행 속도를 통제하는 분산형 화폐 시스템이다.`라 할 수 있다.

## 채굴 난이도

16진수 해시는 각 자리당 0 ~ f 까지 16가지 값을 가질 수 있다. 이 중에서 앞자리가 0인 해시는 16분의 1 확률로 나오며, 앞자리가 00인 해시는 256분의 1 확률로 나온다.
따라서 채굴 난이도는 해시가 특정 개수 이상의 0으로 시작하도록 요구함으로써 조절된다. 예를 들어, 난이도가 4라면 해시가 0000으로 시작해야 하며, 이는 16^4 = 65536분의 1 확률로 발생한다.
비트코인이 태초의 기준값 일 떄는 당시 선행 제로는 8자리였다.

### 자동 조절 알고리즘(Difficulty Adjustment Algorithm)

비트코인은 약 2주(2016 블록)마다 채굴 난이도를 자동으로 조절한다. 만약 지난 2016 블록이 예상 시간(약 14일)보다 빨리 채굴되었다면 난이도를 높이고, 느리게 채굴되었다면 난이도를 낮춘다.
이를 통해 평균 블록 생성 시간이 10분에 가깝도록 유지한다.

중앙은행이 금리를 조절하여 경제를 안정시키는 것과 유사하게, 비트코인은 난이도 조절을 통해 네트워크의 안정성과 보안을 유지한다.
차이라면 금리를 사람에 의해 조절하는 중앙은행과 달리 비트코인은 사전에 정해진 알고리즘에 따라 자동으로 조절된다는 점이다.

## 채굴 풀

비트 코인의 채굴은 물리적인 공장을 연상케하는 대규모 연산 작업이다. 개인이 혼자서 채굴하는 것은 점점 어려워지고 경쟁이 치열해지면서, 채굴자들은 **채굴 풀(Mining Pool)** 이라는 협력체를 형성하게
되었다.
채굴 풀은 여러 채굴자들이 자신의 연산 능력을 모아 공동으로 블록을 채굴하고, 그 보상을 기여도에 따라 나누는 시스템이다.

BTC.com 등이 대표적인 채굴 풀 서비스 제공자이며, 채굴자들은 이들 풀에 가입하여 자신의 채굴 장비를 연결한다. 채굴 풀은 참여자들의 연산 능력을 합산하여 블록을 더 빠르게 찾을 수 있게 해주며,
채굴자들은 안정적인 수익을 기대할 수 있다.

## 논스 범위

블록에서 채굴자가 변경할 수 있는 유일한 값이 논스이며 이 값을 변화시키면서 해시 값을 재계산한다. 그런데 논스는 4바이트 정수 범위 내에서만 변경이 가능하기에 43억 가랑의 시도만 가능하다.
채굴의 난이도가 높으면 이 정도의 논스변화로는 충분하지 않기에 논스 범위를 모두 소진한 채굴자는 블록의 다른 부분(예: 타임스탬프)을 변경하여 새로운 해시 값을 계산해야 한다.

시간이 흐름에 따라 계속 채굴 시도를 할수는 있지만 여전한 문제는 거래한 채굴 풀은 초당 수천 조건의 해시 계산 능력을 보유하고 있다는 점이다.
시간이라는 변수를 넣는다고 해도 논스 범위가 한정적이기에 결국에는 논스 범위를 모두 소진하게 된다.

## 채굴자가 트랜잭션을 선택하는 방법 #1

논스와 타임 스탬프를 변경하며 해시 값을 재계산하더라도 채굴 풀의 해시 계산 능력이 너무 크기 때문에 효율이 크게 떨어진다.
이런 상황이 처해지면 채굴자는 **멤풀(Mempool)** 에 있는 트랜잭션 중 일부를 선택하여 블록에 포함시켜 해시 값을 재계산하는 방법을 사용한다.

멤풀이라함은 네트워크에 전파되었지만 아직 블록에 포함되지 않은 대기 중인 트랜잭션들의 집합이다.
채굴자들은 멤풀에서 채굴할 블록에 트랜잭션들을 수수료가 높은 순서대로 포함시켜서 채굴을 시도하는 것이다. (이 때문에 수수료가 낮은 트랜잭션들은 다음 블록에 포함될 때까지 대기하게 된다.)

결과적으로 블록에 포함되어 있는 트랜잭션 조합을 계속 바꿔가며 해시 값을 재계산하는 방식으로 고성능의 채굴기의 낭비되는 연산 능력을 활용하는 것이다.
고도화된 소프트웨어가 자신의 채굴 풀에 있는 채굴기에게 여러 트랜잭션 조합을 중복없이 전달하기 때문에 사람이 수동으로 트랜잭션을 선택하지는 않는다.

### 거래 수수료

채굴자가 어떤 거래를 블록에 포함하여 채굴을 시도할지는 거래 수수료(Transaction Fee)에 의해 결정된다. 때문에 거래 수수료가 높은 거래일수록 블록에 포함될 확률이 높아진다.
거래 수수료가 너무 낮아 대기 시간이 72시간 이상 넘어가게 되면 거래가 취소되기도 한다.

## 채굴자가 트랜잭션을 선택하는 방법 #2

하나의 블록은 약 1MB 크기이며 이는 약 2000~3000개의 트랜잭션을 포함할 수 있는 용량이다. 채굴자는 멤풀에서 거래 수수료가 높은 순서대로 트랜잭션을 선택하여 블록에 포함시킨다.
복잡한 트랜잭션은 크기가 크기 떄문에 수수료가 높아도 블록에 포함되지 못할 수도 있다.

### 트랜잭션 가속기 (Transaction Accelerator)

일부 채굴 풀은 트랜잭션 가속기 서비스를 제공한다. 사용자는 일정 수수료를 지불하고 자신의 트랜잭션을 우선적으로 처리해달라고 요청할 수 있다.
이 서비스는 특히 네트워크가 혼잡할 때 유용하며, 사용자는 트랜잭션 가속기를 통해 자신의 거래가 더 빨리 블록에 포함되도록 할 수 있다.
(이는 채굴 풀의 수익 모델 중 하나이기도 하다.)

## CPU , GPU, ASIC

채굴은 단순히 컴퓨터를 켜두는 것이 아니라, 누가 더 빠르고 효율적으로 암호화 문제를 풀어내느냐하는 경쟁이다.
CPU는 범용적으로 사용할 수 있지만 채굴을 위한 해시 작업에만 집중하기에는 여러 기능들이 함께 작동하기에 비효율적이다.
일반적으로 초당 천만 해시 이하의 성능을 보이는데, 이는 현대 채굴 풀의 성능에 비하면 매우 낮은 수준이다.

GPU는 화면 출력 및 그래픽 연산에 특화된 하드웨어이며, 행렬 연산을 동시에 처리하기에 해시 연산에 훨씬 효율적이다.
초당 10억 해시 이상의 성능을 낼 수 있어 채굴에 널리 사용되었다. 그러나 GPU도 여전히 범용 하드웨어이기에 채굴에만 최적화된 것은 아니다.

ASIC(응용 특화 집적 회로)은 특정 작업(이 경우 해시 계산)에만 최적화된 하드웨어이다. ASIC 채굴기는 매우 높은 해시 성능(초당 수조 해시)을 제공하며
전력 효율성도 뛰어나다. 이는 채굴 경쟁에서 큰 이점을 제공하며, 현재 대부분의 비트코인 채굴은 ASIC을 사용하여 이루어진다.

### 이더리움과 비트코인의 채굴기 환경

이더리움은 비트코인과 달리 GPU 채굴이 주로 사용되었다. 이는 이더리움의 해시 알고리즘인 Ethash가 메모리 집약적이기 때문에 GPU의 병렬 처리 능력을 활용하는 것이 유리했기 때문이다.
반면, 비트코인은 SHA-256 해시 알고리즘을 사용하며, 이는 ASIC에 최적화되어 있다. 따라서 비트코인 채굴은 주로 ASIC 채굴기가 사용된다

정리하자면 비트코인 네트워크는 순수 연산 능력만을 경쟁하는 구조라 전용 장비를 이용한 채굴 외에는 사실상 경쟁이 불가능해졌으며,
이더리움은 장비 독점에 제한을 두기 위해 메모리 집약적 알고리즘을 채택하여 GPU 채굴이 주로 사용되고 있다는 차이가 있다.

그렇기 때문에 순수 네트워크 해시 파워는 비트코인이 압도적으로 높지만 이게 곧 네트워크가 좋냐 나쁘냐의 척도는 아니다.

### 이더리움의 메모리 집약적 알고리즘

이더리움 채굴은 DAG(Directed Acyclic Graph)라는 대용량 메모리 구조를 사용한다. 이 구조는 채굴자가 해시 계산을 수행할 때 많은 양의 메모리를 필요로 한다.
이 파일은 초기 1GB에서 시작하여 시간이 지남에 따라 점점 커지고 있으며, 채굴을 하기 위해서는 이 DAG 파일을 메모리에 로드해야 한다.
이로인해 순수 연산 능력 뿐 아니라 메모리 용량과 대역폭도 중요한 요소가 된다. ASIC가 아무리 빠르더라도 메모리 대역폭에 크게 제한이 걸리기 때문에 단가 대비 효율이 떨어진다.
이더리움의 이러한 설계는 채굴 장비의 독점을 방지하고, 더 많은 사람들이 채굴에 참여할 수 있도록 하기 위한 목적이 있다.

## 메모리풀 (Mempool) 작동 원리

아직 블록에 포함되지 않은 대기 중인 트랜잭션들은 **메모리풀(Mempool)** 에 저장된다. 메모리풀은 네트워크에 전파된 트랜잭션들이 블록에 포함되기 전까지 임시로 보관되는 공간이다.
중요한 점은 모든 노드가 하나의 거대한 메모리풀을 공유하는 것이 아니라 각 노드가 독립적으로 자신의 메모리풀을 관리한다는 것이다.
물론 주변 노드들과 트랜잭션 정보를 주고받으며 동기화하지만, 각 노드의 메모리풀 상태는 다를 수 있다. 이는 네트워크 지연, 노드의 처리 속도, 정책 차이 등 다양한 요인에 의해 발생한다.

주변 노드로부터 트랜잭션이 전파되면, 해당 트랜잭션의 서명, 잔액, 이중 지불 여부 등의 유효성 검사를 거친 뒤 메모리풀에 저장되어 블록에 추가되기를 기다린다.
블록에 포함되고 해당 블록의 채굴이 확정되면, 해당 트랜잭션은 메모리풀에서 제거된다.

### 메모리풀로 인한 네트워크 혼잡

메모리풀의 상태는 네트워크 혼잡도를 보여주는 가장 좋은 지표이다.

- Mempool Size : 메모리풀에 대기 중인 트랜잭션의 총 크기(바이트 단위), 이 수치가 높으면 전송 수수료가 높아질 수 있다.
- Transaction Count : 메모리풀에 대기 중인 트랜잭션의 총 개수, 블록 생성 주기 (10분 정도)에 따라 변경, 이 수치가 높으면 블록에 포함되기까지 대기 시간이 길어질 수 있다.
- Unconfirmed Txs : 승인되지 않은 거래 수, 시장 가격이 급등락할 때 이 수치가 급증할 수 있다.

## 고아블록 (Orphan Block)

고아 블록이란, 블록체인 네트워크에서 두 개 이상의 채굴자가 거의 동시에 새로운 블록을 생성했을 때 발생하는 현상이다.
블록체인은 둘 중 하나의 줄기로 이어져야 하므로, 결국 하나의 블록만이 메인 체인에 포함되고, 나머지 블록은 고아 블록이 된다.

100 번의 블록이 동시에 생성되었다고 가정한다. 이때, 네트워크의 일부 노드는 블록 A를 먼저 받고, 다른 일부 노드는 블록 B를 먼저 받았다고 하자.
각 노드는 자신이 먼저 받은 블록을 기준으로 다음 블록을 채굴하기 시작한다. 이로 인해 두 개의 경쟁 체인이 형성된다.
그러나 시간이 지나면서 한 체인이 다른 체인보다 더 길어지게 된다. 블록체인의 규칙에 따라 가장 긴 체인이 유효한 체인으로 인정되므로, 짧은 체인의 블록들은 고아 블록이 된다.

고아 블록은 네트워크의 분산 특성 때문에 발생하는 자연스러운 현상이다. 고아 블록이 발생하더라도 네트워크는 결국 하나의 일관된 체인으로 수렴하게 된다.
사라지게 된 고아 블록은 폐기되며, 안에 있던 트랜잭션들은 다시 각 노드의 멤풀로 돌아가게 된다.

고아 블록 현상에 의해 이중 지출에 대한 위험이 생기게 된다. 예를 들어, 사용자가 블록 A에 포함된 거래를 통해 상품을 구매했다고 가정하자.
만약 블록 A가 고아 블록이 되고 블록 B가 메인 체인에 포함된다면, 사용자의 거래는 무효화된다. 이로 인해 사용자는 동일한 자금을 다시 사용할 수 있게 되어 이중 지출 문제가 발생할 수 있다.
이를 방지하기 위해 블록체인 네트워크는 일정 수의 확인(confirmation) 단계를 거친 후에 거래를 최종적으로 인정하는 방식을 사용한다.

거래소나 지갑 서비스는 최소 6회의 승인을 요구하는데, 이는 블록체인 네트워크에서 고아 블록이 발생할 가능성을 줄이고 거래의 최종성을 보장하기 위함이다.
수학적으로 6개의 블록이 추가로 생성될 때까지 기다리면, 고아 블록이 발생할 확률이 매우 낮아지기(거의 0%) 때문에 거래의 안정성이 크게 향상된다.

## 51% 공격

51% 공격이란, 블록체인 네트워크에서 단일 채굴자나 채굴 풀(또는 이들의 연합)이 전체 네트워크 해시 파워의 51% 이상을 장악하여 네트워크를 통제하는 상황을 말한다.
명확하게 정의하면 해킹이 아니라, 네트워크의 합의 규칙을 악용하는 행위이다. 즉, 암호학을 뚫는 것이 아니라, 남들보다 더 빨리 채굴할 수 있는 압도적인 물리적 힘을 가지게 되는 것이다.

예시로 다음과 같은 시나리오를 생각해보자.

1. 공격자 그룹은 최신 블록을 복사한 뒤, 자신들만의 비밀 체인을 생성하기 시작한다. 이 체인은 네트워크에 전파하지 않는다.
2. 기존 네트워크 그룹의 블록 생성 속도보다 공격자 그룹의 블록 생성 속도가 더 빠르다면, 결국 공격자 그룹의 비밀 체인이 기존 체인보다 길어지게 된다.
3. 공격자 그룹이 비밀 체인을 네트워크에 공개하면, 네트워크는 가장 긴 체인을 유효한 체인으로 인정한다. 이로 인해 공격자 그룹의 체인이 메인 체인이 되고, 기존 체인은 무효화된다.
4. 공격자 그룹은 자신들의 체인에 포함된 거래들을 되돌릴 수 있으며, 이를 통해 이중 지출(Double Spending)을 실행할 수 있다.

결과적으로 공격자들은 돈을 지불하여 상품이나 서비스를 구매한 후, 자신들의 체인을 공개하여 해당 거래를 무효화함으로써 동일한 자금을 다시 사용할 수 있게 된다.

### 방어책과 현실성

이론적으로 가능하지만, 현실적으로는 매우 어렵다. 비트코인과 같은 대규모 네트워크에서는 전체 해시 파워의 51%를 장악하는 것이 막대한 비용과 자원을 요구한다.
또한, 51% 공격이 성공하더라도 네트워크의 신뢰성이 크게 훼손되어 해당 암호화폐의 가치가 급락할 수 있다. 이는 공격자 자신에게도 손해가 될 수 있다.
따라서 대부분의 채굴자들은 장기적인 이익을 위해 네트워크의 안정성을 유지하는 방향으로 행동한다.

또한, 거래소 등에서 6회 이상의 승인을 요구하는 것도 51% 공격에 대한 방어책 중 하나이다.
6개 이상의 블록이 추가로 생성될 때까지 기다리면, 공격자가 자신의 체인을 메인 체인으로 만들기 위해 필요한 해시 파워가 기하급수적으로 증가하기 때문에, 공격의 성공 확률이 매우 낮아진다.
