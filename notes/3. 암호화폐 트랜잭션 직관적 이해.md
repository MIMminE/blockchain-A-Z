## 트랜잭션과 UTXO

블록체인은 기존의 은행에서의 계좌 잔고와는 다른 개념을 사용하며, 이를 이해하기 위해서는 트랜잭션과 **UTXO(Unspent Transaction Output)** 의 개념을 알아야 한다.

### UTXO (Unspent Transaction Output)

아직 사용되지 않은 트랙잭션 출력이라는 의미를 가지고 있으며, 누군가가 나에게 보냈지만 아직 사용하지 않은 돈의 덩어리라 생각하면 된다.
UTXO들을 지갑이라는 상자에 담아두고 필요할 때 꺼내서 사용하는 개념이다. (A에게 받은 0.5 BTC, B에게 받은 1.2 BTC 등)

UTXO는 한 번 사용되면 사라지며, 새로운 트랜잭션이 생성될 때마다 새로운 UTXO가 만들어지며, 전액 사용 원칙이 있다.
예를 들어, 1 BTC를 보내야 하는데 0.6 BTC와 0.5 BTC의 UTXO가 있다면, 두 개를 모두 사용하여 1.1 BTC를 만들고, 0.1 BTC는 다시 나에게 거스름돈으로 새로운 UTXO로 생성된다.

처음엔 낯설지만 현금을 사용하는 것과 비슷하다고 생각하면 이해하기 쉽다. 5,000원짜리 지폐와 1,000원짜리 지폐를 사용하여 6,000원을 만들고, 거스름돈을 받는 것과 유사하다.

## 트랜잭션 수수료 (Transaction Fee)

블록체인에는 수수료 입력란이라는 것이 따로 존재하지 않는다. 트랜잭션을 생성할 때, 입력(Inputs)과 출력(Outputs)을 정의하는데, 입력의 총합이 출력의 총합보다 크면 그 차액이 수수료로 간주된다.
예를 들어, 1.5 BTC의 UTXO를 입력으로 사용하여 1.4 BTC를 출력으로 보내면, 0.1 BTC가 수수료로 채굴자에게 지급된다.
수수료는 네트워크 혼잡도에 따라 달라지며, 수수료가 높을수록 트랜잭션이 더 빨리 처리될 가능성이 높아진다.

### 코인베이스 트랜잭션(Coinbase Transaction)

블록체인 탐색기에서 블록을 열어보면 가장 먼저 위치한 트랜잭션을 **코인베이스 트랜잭션**이라고 한다.
From은 0이고, To에는 금액이 적혀있다. 즉 새로 생성된 코인(블록 보상)이 채굴자에게 지급되는 트랜잭션이다.
이는 해당 블록에 있는 트랜잭션들의 수수료와 새로 생성된 코인을 합산한 금액이 채굴자에게 지급되는 것을 의미한다.

## 지갑 (Wallet)

현실의 은행에서는 데이터베이스를 통해 확정된 숫자가 잔고로 저장되어 있지만 블록체인은 잔고라는 개념이 없이 오로지 거래 내역(트랜잭션)만 존재한다.
지갑이라는 것은 단순하게 블록체인 내에서 내가 소유한 UTXO를 찾아내는 도구일 뿐이다. (물리적인 코인이나 디지털 형태의 코인은 존재하지 않는다.)

내가 비트코인을 소유하고 있다는 것은 블록체인상에 기록된 특정 UTXO를 내가 다른 주소로 보낼 수 있는 권한(개인키)를 가지고 있다는 의미이다.

### 서명: 개인키 및 공개키

블록체인은 누구나 장부를 볼 수 있고, 누구나 트랜잭션 요청을 네트워크에 전파할 수 있다.
중앙 관리자가 없으므로 트랜잭션이 진짜 나로부터 온 것인지, 내가 소유한 UTXO를 사용하려는 것인지를 증명할 방법이 필요하다.
이를 위해 공개키 암호화 방식을 사용한다. 개인키로 트랜잭션에 서명하면, 누구나 공개키로 해당 서명을 검증할 수 있다.

블록체인에서 거래가 승인되는 과정은 서명과 검증의 두 단계로 이루어진다.

1. **서명(Signing)**: 트랜잭션을 생성할 때, 소유자는 자신의 개인키로 트랜잭션에 서명한다. 서명과 공개키를 트랜잭션과 함께 네트워크에 전송한다.
2. **검증** : 네트워크의 노드들은 트랜잭션을 받으면, 공개키를 사용하여 서명을 검증한다. 서명이 유효하면, 해당 트랜잭션이 진짜 소유자로부터 온 것임을 확인하고, UTXO가 사용되지 않았는지 확인한다.

**타원 곡선 암호화(Elliptic Curve Cryptography, ECC)** 는 개인키와 공개키를 생성하는 데 사용되는 수학적 방법이다.
이 방법은 개인키를 통해 공개키를 생성하는 것은 쉬우나, 공개키로부터 개인키를 역산하는 것은 현재의 기술로는 불가능에 가깝다.

서명 검증에 성공했다는 것은 트랜잭션이 진짜 소유자로부터 왔으며, 해당 UTXO를 사용할 권한이 있음을 의미한다.

## 세그윗(SegWit)

비트코인 블록 하나는 1MB라는 용량 제한이 있다. 이는 초기 비트코인 네트워크의 속도와 효율성을 유지하기 위한 조치였다.
하지만 시간이 지나면서 트랜잭션 수가 증가하고, 블록 크기 제한이 병목 현상을 일으키기 시작했다.
이를 해결하기 위해 2017년에 도입된 것이 **세그윗(Segregated Witness)** 이다.

트랜잭션 데이터의 60~70%가 서명 데이터로 구성되어 있으며, 세그윗은 이 서명 데이터를 트랜잭션 본문에서 분리하여 별도의 공간에 저장하는 방식이다.
이를 통해 하나의 블록에 더 많은 트랜잭션을 포함시킬 수 있게 되어, 네트워크의 처리 속도와 효율성이 크게 향상되었다.

세그윗 도입 이후, 비트코인 네트워크는 더 많은 트랜잭션을 처리할 수 있게 되었으며, 수수료도 감소하는 효과가 있었다.
세그윗은 또한 라이트닝 네트워크와 같은 2계층 솔루션의 기반이 되어, 비트코인의 확장성과 사용성을 더욱 높이는 데 기여하고 있다.

### 머클 트리(Merkle Tree)

머클 트리는 이진 트리라고도 불리며, 블록체인에서는 트랜잭션 데이터를 효율적으로 요약하고 검증하는 데 사용된다.
머클 트리는 다음과 같은 방식으로 구성된다.

1. **리프 노드(Leaf Nodes)**: 트랜잭션 각각의 해시값이 리프 노드로 사용된다.
2. **내부 노드(Internal Nodes)**: 리프 노드의 해시값을 쌍으로 묶어 다시 해시값을 계산하여 부모 노드를 만든다. 이 과정을 반복하여 최종적으로 하나의 루트 노드(Merkle Root)를 생성한다.
3. **루트 노드(Merkle Root)**: 블록 헤더에 포함되며, 해당 블록에 포함된 모든 트랜잭션의 무결성을 대표하는 값이다.

블록 체인의 헤더 부분에 머클 루트가 포함되며, 이를 통해 블록에 포함된 트랜잭션들이 변경되지 않았음을 검증할 수 있다.
전체 데이터가 아닌 머클 루트만으로도 트랜잭션의 무결성을 확인할 수 있어 효율적이다. 이 덕분에 경량 클라이언트(SPVs)가 전체 블록체인을 다운로드하지 않고도 트랜잭션을 검증할 수 있다.

세그윗 도입으로 트랜잭션의 서명 데이터가 분리되면서 약간의 변화가 생기게 된다.
세그윗 트랜잭션에서는 머클 트리가 두 개로 나뉘게 된다. 하나는 기존의 트랜잭션 데이터용 머클 트리이고, 다른 하나는 서명 데이터용 머클 트리이다.
이로 인해 세그윗 트랜잭션의 무결성을 검증할 때는 두 개의 머클 루트를 모두 고려해야 한다.

서명 데이터를 검증하는 머클 트리를 코인베이스 트랜잭션에 포함시키는 방식으로, 세그윗 트랜잭션의 무결성을 보장한다.
이렇게 변화를 주더라도 기존의 레거시 시스템과의 호환성을 유지되므로 문제가 없다.

## 공개키 대 비트코인 주소

비트코인 주소는 공개키에서 파생된 값으로, 공개키를 해시 함수에 두 번 적용하여 생성된다.
이 과정은 다음과 같다.

1. 공개키에 SHA-256 해시 함수를 적용하여 중간 해시값을 생성한다.
2. 중간 해시값에 RIPEMD-160 해시 함수를 적용하여 최종 해시값(비트코인 주소)을 생성한다.
   비트코인 주소는 공개키보다 짧고, 오류 검출 기능이 포함되어 있어 사용하기 편리하다.

비트코인 주소는 공개키를 직접 노출하지 않으면서도, 해당 주소로 보내진 비트코인을 소유할 수 있는 권한을 제공한다.
따라서, 비트코인 주소는 공개키의 해시값으로서, 트랜잭션에서 사용되는 식별자 역할을 한다.

## 

